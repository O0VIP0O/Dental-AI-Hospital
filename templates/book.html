<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cytology Secretary Dashboard</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600&family=Roboto:wght@400;500&display=swap" rel="stylesheet">




    <style>
        :root {
  /* Dental Theme Colors */
  --primary-blue: #007BFF;
  --primary-blue-light: #F0F7FF;
  --primary-blue-dark: #0056B3;
  --success-green: #28A745;
  --danger-red: #DC3545;
  --warning-yellow: #FFC107;
  --light-gray: #F8F9FA;
  --medium-gray: #6C757D;
  --dark-gray: #343A40;
  
  /* Layout */
  --sidebar-collapsed: 60px;
  --sidebar-expanded: 240px;
  --patient-queue-width: 304px;
  
  /* Light Theme */
  --bg-primary: #FAFBFC;
  --bg-secondary: #FFFFFF;
  --bg-tertiary: #F8F9FA;
  --text-primary: #1A202C;
  --text-secondary: #4A5568;
  --text-muted: #718096;
  --border-color: #E2E8F0;
  --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.1);
  --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.1);
  --shadow-lg: 0 10px 25px rgba(0, 0, 0, 0.15);
  
  /* Transitions */
  --transition-fast: 150ms ease;
  --transition-base: 250ms ease;
  --transition-slow: 400ms ease;
}

[data-theme="dark"] {
  --bg-primary: #0F172A;
  --bg-secondary: #1E293B;
  --bg-tertiary: #334155;
  --text-primary: #F1F5F9;
  --text-secondary: #CBD5E1;
  --text-muted: #94A3B8;
  --border-color: #334155;
  --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.3);
  --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.4);
  --shadow-lg: 0 10px 25px rgba(0, 0, 0, 0.5);
}

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background-color: var(--bg-primary);
            color: var(--text-primary);
              transition: background-color var(--transition-base), color var(--transition-base);

        }
       

        /* نص عربي */
        [lang="ar"], .arabic-text {
            font-family: 'Cairo', sans-serif;
            direction: rtl;
            text-align: right;
        }

        /* نص إنجليزي */
        [lang="en"], .english-text {
            font-family: Cambria, Cochin, Georgia, Times, 'Times New Roman', serif;
            direction: ltr;
            text-align: left;
        }


        .container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
       
       
        .nav-menu {
            list-style: none;
        }

       .nav-link {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            color: var(--text-secondary);
            text-decoration: none;
            transition: var(--transition-base);
            font-size: 18px;
        }

        /* Hover */
        .nav-link:hover {
            background-color: var(--primary-blue-light);
            color: var(--primary-blue);
        }

        /* Active */
        .nav-link.active {
            background-color: var(--primary-blue) !important;
            color: var(--bg-secondary) !important;
            border-right: 3px solid var(--primary-blue-dark);
        }


        .nav-icon {
            width: 20px;
            height: 20px;
            margin-right: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Main Content */
        .main-content {
            width: 100%;
            background-color: var(--bg-primary);
        }

        /* Header */
        .header {
            background-color: var(--bg-secondary);
            padding: 15px 30px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: var(--shadow-sm);
            top: 0;
            z-index: 100;
        }

        .user-info {
            display: flex;
            align-items: center;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 35px;
        }

        .user-details h4 {
            font-size: 20px;
            margin-bottom: 2px;
        }

        .user-details span {
            font-size: 17px;
            color: var(--text-muted);
        }

        .datetime {
            text-align: right;
            font-size: 17px;
            color: var(--text-muted);
        }

        /* Content Area */
        .content-area {
            padding: 30px;
        }

        /* Controls Section */
        .controls-section {
            display: flex;
            justify-content: space-between; /* يوزع اليمين والشمال */
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 20px;
            gap: 15px;
        }

        .left-controls, .right-controls {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        /* Push search and filter to the left by making buttons push to the right */
        .add-patient-btn, .payment-btn {
            background-color: var(--primary-blue);
            color: var(--bg-secondary);
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: var(--transition-base);
            order: 2; /* Move buttons to the right */
        }

        .add-patient-btn.reservation{
            background-color: var(--primary-blue-dark);
            text-decoration: none;
        }

        .add-patient-btn:hover, .payment-btn:hover {
            background-color: var(--primary-blue-dark);
        }

        .search-input, .filter-select {
            padding: 10px 15px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 17px;
            outline: none;
            transition: var(--transition-base);
            background-color: var(--bg-secondary);
            order: 1; /* Keep search/filter on the left */
        }

        .search-input:focus, .filter-select:focus {
            border-color: var(--primary-blue);
        }

        .search-input {
            width: 250px;
            margin-left: auto; /* Push search input to create space */
        }

        .filter-select {
            width: 200px;
        }

        /* Stats Cards */
        .stats-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--bg-secondary);
            padding: 20px;
            border-radius: 12px;
            box-shadow: var(--shadow-md);
            text-align: center;
        }

        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            color: var(--primary-blue);
            margin-bottom: 5px;
        }

        .stat-label {
            color: var(--text-muted);
            font-size: 17px;
        }

        /* Table */
        .table-container {
            background-color: var(--bg-secondary);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--shadow-md);
        }

        .table {
            width: 100%;
            border-collapse: collapse;
        }

        .table th {
            background-color: var(--primary-blue);
            color: var(--bg-secondary);
            padding: 15px 10px;
            text-align: left;
            font-weight: 600;
            font-size: 18px;
        }

        .table td {
            padding: 12px 10px;
            border-bottom: 1px solid var(--border-color);
            font-size: 20px;
        }

        .table tr:hover {
            background-color: var(--primary-blue-light);
        }

        .table tr:last-child td {
            border-bottom: none;
        }

        /* Status Select Styling */
        .status-select {
            border: none;
            background: transparent;
            font-size: 17px;
            font-weight: 500;
            padding: 4px 8px;
            border-radius: 20px;
            min-width: 100px;
            cursor: pointer;
        }

        .status-select.status-waiting {
            background-color: var(--warning-yellow);
            color: var(--dark-gray);
        }

        .status-select.status-completed {
            background-color: var(--primary-blue-light);
            color: var(--primary-blue-dark);
        }

        .status-select.status-paid {
            background-color: var(--success-green);
            color: var(--bg-secondary);
        }

        .action-buttons {
            display: flex;
            gap: 5px;
        }

        .action-btn {
            width: 32px;
            height: 32px;
            background-color: var(--bg-tertiary);
            border: none;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition-base);
            font-size: 14px;
        }

        .action-btn:hover {
            background-color: var(--border-color);
        }

        .action-btn.edit {
            color: var(--primary-blue);
        }

        .action-btn.print {
            color: var(--success-green);
        }
        .action-btn.camera {
            color: var(--primary-blue-dark);
        }

        .action-btn.payment {
            color: var(--warning-yellow);
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background-color: var(--bg-secondary);
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            transform: scale(0.9);
            transition: transform 0.3s ease;
            box-shadow: var(--shadow-lg);
        }

        .modal-overlay.active .modal {
            transform: scale(1);
        }

        .modal-header {
            padding: 24px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background-color: var(--primary-blue);
            color: var(--bg-secondary);
        }

        .modal-title {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 20px;
            font-weight: 600;
        }

        .close-btn {
            width: 32px;
            height: 32px;
            background-color: rgba(255,255,255,0.1);
            border: none;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: var(--bg-secondary);
            transition: background-color 0.2s;
        }

        .close-btn:hover {
            background-color: rgba(255,255,255,0.2);
        }

        .modal-body {
            padding: 24px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            font-size: 18px;
            color: var(--text-primary);
        }

        .form-input, .form-select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 18px;
            outline: none;
            transition: var(--transition-base);
            background-color: var(--bg-secondary);
        }

        .form-input:focus, .form-select:focus {
            border-color: var(--primary-blue);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            margin-top: 32px;
        }

        .btn {
            flex: 1;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 17px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-cancel {
            background-color: var(--bg-tertiary);
            color: var(--text-secondary);
        }

        .btn-cancel:hover {
            background-color: var(--border-color);
        }

        .btn-primary {
            background-color: var(--primary-blue);
            color: var(--bg-secondary);
        }

        .btn-primary:hover {
            background-color: var(--primary-blue-dark);
        }

        /* Print Styles */
        .print-card {
            display: none;
            background: var(--bg-secondary);
            padding: 40px;
            margin: 20px;
            border: 2px solid var(--primary-blue);
        }

        .print-header {
            text-align: center;
            border-bottom: 2px solid var(--primary-blue);
            padding-bottom: 20px;
            margin-bottom: 30px;
        }

        .print-header h1 {
            font-size: 24px;
            margin-bottom: 10px;
        }

        .print-info {
 
            gap: 20px;
            margin-bottom: 30px;
        }

        .print-section {
            border: 1px solid var(--border-color);
            padding: 15px;
            border-radius: 8px;
        }

        .print-section h3 {
            margin-bottom: 15px;
            color: var(--primary-blue);
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 5px;
        }

        @media print {
            body * {
                visibility: hidden;
            }
            
            .print-card, .print-card * {
                visibility: visible;
            }
            
            .print-card {
                display: block !important;
                position: absolute;
                top: 0;
                left: 0;
                width: 100% !important;
                margin: 0 !important;
                border: none !important;
            }
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .main-content {
                margin-left: 0;
            }
            
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s;
            }
            
            .sidebar.open {
                transform: translateX(0);
            }
            
            .controls-section {
                flex-direction: column;
                align-items: stretch;
            }
            
            .search-input, .filter-select {
                width: 100%;
            }
            
            .stats-section {
                grid-template-columns: 1fr;
            }
            
            .table-container {
                overflow-x: auto;
            }
            
            .table {
                min-width: 800px;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
        }

        .mobile-menu-btn {
            display: none;
            width: 32px;
            height: 32px;
            background: none;
            border: none;
            cursor: pointer;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 4px;
        }

        .mobile-menu-btn span {
            width: 20px;
            height: 2px;
            background-color: var(--text-primary);
            transition: var(--transition-base);
        }

        @media (max-width: 768px) {
            .mobile-menu-btn {
                display: flex;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Sidebar -->
       
        <!-- Main Content -->
        <main class="main-content">
            <!-- Header -->
            <header class="header">
                <div class="header-left">
                  
                    <div class="user-info">
                        <div class="user-avatar"><i class="fa-solid fa-circle-user"></i></div>
                        <div class="user-details">
                            <h4>Secretary</h4>
                            <span>Admin</span>
                        </div>
                    </div>
                </div>
                
                <div class="header-right">
                    <div class="datetime">
                        <div id="time">12:29 PM</div>
                        <div id="date">Sep 02, 2023</div>
                    </div>
                </div>
            </header>

            <!-- Content Area -->
            <div class="content-area">
                <!-- Stats Section -->
                <div class="stats-section">
                    <div class="stat-card">
                        <div class="stat-number" id="totalPatients">0</div>
                        <div class="stat-label">Today patients</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="waitingCount">0</div>
                        <div class="stat-label">Waiting</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="completedCount">0</div>
                        <div class="stat-label">Complete</div>
                    </div>
                    
                </div>
<!-- Controls Section -->
<div class="controls-section">
    <!-- Left side -->
    <div class="left-controls">
        <input type="text" class="search-input" id="searchInput" placeholder="Search by ID or Name">
        
      
    </div>

    <!-- Right side -->
    <div class="right-controls">
        <button class="add-patient-btn" onclick="openAddPatientModal()" type="button">
            <i class="fas fa-plus"></i>
            Add Patient
        </button>
    </div>
</div>


                <!-- Table -->
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Name</th>
                                <th>Age</th>
                                <th>Phone</th>
                                <th>Date</th>
                                <th>Time</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody">
                            <!-- Table rows will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <!-- Add/Edit Patient Modal -->
    <div class="modal-overlay" id="patientModal" onclick="closeModal(event)">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-user-plus"></i>
                    <span id="modalTitle">Add Patient</span>
                </div>
                <button class="close-btn" onclick="closePatientModal()">✕</button>
            </div>
            <div class="modal-body">
                <form id="patientForm">
                        <div class="form-group" id="patientIdGroup" style="display: none;">
                            <label class="form-label">Patient ID</label>
                            <input type="text" class="form-input" id="patientId" readonly>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Patient Name</label>
                            <input type="text" class="form-input" id="patientName" required>
                        </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Age</label>
                            <input type="number" class="form-input" id="patientAge" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Phone</label>
                            <input type="tel" class="form-input" id="patientPhone" required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Gender</label>
                        <select class="form-select" id="gender" required>
                            <option value=""></option>
                            <option value="M">Male</option>
                            <option value="F">Female</option>
                        </select>
                    </div>
                      
                    
                    <div class="modal-actions">
                        <button type="button" class="btn btn-cancel" onclick="closePatientModal()">CANCEL</button>
                        <button type="submit" class="btn btn-primary" id="submitBtn">ADD PATIENT</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Payment Modal -->

    <!-- Print Card -->
    <div class="print-card" id="printCard">
        <div class="print-header">
            <h1>Assuit Dental Hospital</h1>
            <p>Patient Details Card</p>
        </div>
        
        <div class="print-info">
            <div class="print-section">
                <h3>Patient Information</h3>
                <p><strong>ID:</strong> <span id="printId"></span></p>
                <p><strong>Name:</strong> <span id="printName"></span></p>
                <p><strong>Age:</strong> <span id="printAge"></span></p>
                <p><strong>Phone:</strong> <span id="printPhone"></span></p>
                <p><strong>Gender:</strong> <span id="printGender"></span></p>
            </div>
                     
        </div>
        
        
    </div>

    <script>
     let patients = [];

let editingPatientId = null;
let paymentPatientId = null;

// Initialize app
document.addEventListener('DOMContentLoaded', function() {
    console.log('App initializing...');
    fetchPatients();
    updateDateTime();
    setInterval(updateDateTime, 1000);
    setupEventListeners();
    console.log('App initialized successfully');
});

// Fetch patients from API
async function fetchPatients() {
    try {
        const response = await fetch('http://127.0.0.1:8000/api/home/show/cases');
        const result = await response.json();
        
        if (result.success && result.patients) {
            // Map API response to match our data structure
            patients = result.patients.map(p => ({
                id: p.case_id,
                name: p.name,
                age: p.age,
                phone: p.phone,
                gender: p.gender,
                date: p.appointment_date,
                time: p.appointment_time
            }));
            
            console.log('Patients loaded:', patients);
            populateTable();
            updateStats();
        } else {
            console.error('Failed to load patients');
        }
    } catch (error) {
        console.error('Error fetching patients:', error);
    }
}

// Event listeners
function setupEventListeners() {
    const searchInput = document.getElementById('searchInput');
    const specimenFilter = document.getElementById('specimenFilter');
    const patientForm = document.getElementById('patientForm');
    const paymentForm = document.getElementById('paymentForm');
    const paymentAmount = document.getElementById('paymentAmount');
    
    if (searchInput) searchInput.addEventListener('input', handleSearch);
    if (specimenFilter) specimenFilter.addEventListener('change', handleFilter);
    if (patientForm) patientForm.addEventListener('submit', handlePatientSubmit);
    if (paymentForm) paymentForm.addEventListener('submit', handlePaymentSubmit);
    if (paymentAmount) paymentAmount.addEventListener('input', calculateNewRemaining);
    
    console.log('Event listeners setup complete');
}

// Get filtered patients
function getFilteredPatients() {
    const searchInput = document.getElementById('searchInput');
    const specimenFilterEl = document.getElementById('specimenFilter');
    
    const searchTerm = searchInput ? searchInput.value.toLowerCase().trim() : '';
    const specimenFilter = specimenFilterEl ? specimenFilterEl.value : '';
    
    let filtered = [...patients];
    
    // Apply search filter
    if (searchTerm) {
        filtered = filtered.filter(p => 
            (p.id && p.id.toLowerCase().includes(searchTerm)) || 
            (p.name && p.name.toLowerCase().includes(searchTerm)) ||
            (p.phone && p.phone.includes(searchTerm))
        );
    }
    
    // Apply specimen filter
    if (specimenFilter) {
        filtered = filtered.filter(p => p.specimen === specimenFilter);
    }
    
    return filtered;
}

// Populate table
function populateTable() {
    const tableBody = document.getElementById('tableBody');
    if (!tableBody) {
        console.error('Table body not found');
        return;
    }
    
    const patientsToShow = getFilteredPatients();
    
    tableBody.innerHTML = '';
    
    if (patientsToShow.length === 0) {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td colspan="11" style="text-align: center; color: #666; padding: 20px;">No patients found</td>`;
        tableBody.appendChild(tr);
        return;
    }
    
    patientsToShow.forEach(patient => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${patient.id || ''}</td>
            <td>${patient.name || ''}</td>
            <td>${patient.age || ''}</td>
            <td>${patient.phone || ''}</td>
            <td>${patient.date || ''}</td>
            <td>${patient.time || ''}</td>
           
            <td>
                <div class="action-buttons">
                    <button class="action-btn edit" data-patient-id="${patient.id}" title="Edit">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="action-btn print" data-patient-id="${patient.id}" title="Print">
                        <i class="fas fa-print"></i>
                    </button>
                 
                </div>
            </td>
        `;
        tableBody.appendChild(tr);
        
        // Add event listeners
        const editBtn = tr.querySelector('.action-btn.edit');
        const printBtn = tr.querySelector('.action-btn.print');
        
        if (editBtn) {
            editBtn.addEventListener('click', () => editPatient(patient.id));
        }
        if (printBtn) {
            printBtn.addEventListener('click', () => printPatient(patient.id));
        }
    });
}

// Update statistics
function updateStats() {
    const todayPatients = getTodayPatients();
    
    const totalPatientsEl = document.getElementById('totalPatients');
    const waitingCountEl = document.getElementById('waitingCount');
    const completedCountEl = document.getElementById('completedCount');
    const paidCountEl = document.getElementById('paidCount');
    
    if (totalPatientsEl) totalPatientsEl.textContent = todayPatients.length;
    if (paidCountEl) paidCountEl.textContent = todayPatients.filter(p => p.status === 'paid').length;
}

// Get today's patients (for stats)
function getTodayPatients() {
    const today = new Date().toISOString().split('T')[0];
    return patients.filter(p => p.date === today);
}

// Handle search
function handleSearch() {
    populateTable();
}



// Modal functions
function openAddPatientModal() {
    console.log('Opening add patient modal...');
    editingPatientId = null;
    const modalTitle = document.getElementById('modalTitle');
    const submitBtn = document.getElementById('submitBtn');
    const patientForm = document.getElementById('patientForm');
    const patientIdGroup = document.getElementById('patientIdGroup');
    
    if (modalTitle) modalTitle.textContent = 'Add Patient';
    if (submitBtn) submitBtn.textContent = 'ADD PATIENT';
    if (patientForm) patientForm.reset();
    if (patientIdGroup) patientIdGroup.style.display = 'none';
    
    const modal = document.getElementById('patientModal');
    if (modal) {
        modal.classList.add('active');
        document.body.style.overflow = 'hidden';
        console.log('Modal opened successfully');
    } else {
        console.error('Patient modal not found!');
    }
}

function editPatient(patientId) {
    console.log('editPatient called with ID:', patientId);
    console.log('Current patients array:', patients);
    const patient = patients.find(p => p.id === patientId);
    console.log('Found patient:', patient);
    if (patient) {
        editingPatientId = patientId;
        
        const modalTitle = document.getElementById('modalTitle');
        const submitBtn = document.getElementById('submitBtn');
        const patientIdGroup = document.getElementById('patientIdGroup');
        
        if (modalTitle) modalTitle.textContent = 'Edit Patient';
        if (submitBtn) submitBtn.textContent = 'UPDATE PATIENT';
        if (patientIdGroup) patientIdGroup.style.display = 'block';
        
        // Populate form with patient data
        const patientIdField = document.getElementById('patientId');
        const patientNameField = document.getElementById('patientName');
        const patientAgeField = document.getElementById('patientAge');
        const patientPhoneField = document.getElementById('patientPhone');
        
        if (patientIdField) patientIdField.value = patient.id || '';
        if (patientNameField) patientNameField.value = patient.name || '';
        if (patientAgeField) patientAgeField.value = patient.age || '';
        if (patientPhoneField) patientPhoneField.value = patient.phone || '';
        
        // Handle gender - normalize the value
        const genderField = document.getElementById('gender');
        console.log('Gender field found:', genderField);
        console.log('Patient gender value:', patient.gender);
        if (genderField && patient.gender) {
            const genderValue = patient.gender.toString().toUpperCase();
            console.log('Normalized gender value:', genderValue);
            // Map common gender values to M/F
            if (genderValue === 'M' || genderValue === 'MALE') {
                genderField.value = 'M';
            } else if (genderValue === 'F' || genderValue === 'FEMALE') {
                genderField.value = 'F';
            } else {
                genderField.value = patient.gender;
            }
            console.log('Gender field set to:', genderField.value);
        }
        
        const modal = document.getElementById('patientModal');
        if (modal) {
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
            console.log('Edit modal opened successfully');
        } else {
            console.error('Patient modal not found!');
        }
    } else {
        console.error('Patient not found with ID:', patientId);
    }
}

function closePatientModal() {
    const modal = document.getElementById('patientModal');
    const patientForm = document.getElementById('patientForm');
    
    if (modal) modal.classList.remove('active');
    document.body.style.overflow = '';
    if (patientForm) patientForm.reset();
    editingPatientId = null;
}

// Handle patient form submission
async function handlePatientSubmit(e) {
    e.preventDefault();
    
    const patientName = document.getElementById('patientName').value;
    const patientAge = parseInt(document.getElementById('patientAge').value);
    const phoneNumber = document.getElementById('patientPhone').value;
    const gender = document.getElementById('gender').value;
    
    const patientData = {
        id: document.getElementById('patientId')?.value || `P${Date.now()}`,
        name: patientName,
        age: patientAge,
        phone: phoneNumber,
        gender: gender,
        date: new Date().toISOString().split('T')[0],
        time: new Date().toLocaleTimeString('en-US', { hour12: false })
    };

    if (editingPatientId) {
        // Update existing patient - Call API
        try {
            const requestBody = {
                editpatientID: String(editingPatientId),
                editpatientName: patientName,
                editpatientAge: patientAge,
                editgender: gender,
                editphoneNumber: phoneNumber
            };
            
            console.log('Sending update request with body:', requestBody);
            
            const response = await fetch('http://127.0.0.1:8000/api/v1/home/edit/case', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestBody)
            });

            console.log('Response status:', response.status);
            
            if (response.status === 422) {
                const errorDetail = await response.json();
                console.error('Validation error (422):', errorDetail);
                alert('Validation Error: ' + JSON.stringify(errorDetail.detail || errorDetail));
                return;
            }
            
            const result = await response.json();
            console.log('Response data:', result);
            
            if (result.success) {
                // Update local array on success
                const patientIndex = patients.findIndex(p => p.id === editingPatientId);
                if (patientIndex !== -1) {
                    patients[patientIndex] = {
                        ...patients[patientIndex],
                        ...patientData
                    };
                }
                
                populateTable();
                updateStats();
                closePatientModal();
                alert('Patient updated successfully!');
            } else {
                alert('Error: ' + (result.message || 'Failed to update patient'));
            }
        } catch (error) {
            console.error('Error updating patient:', error);
            alert('Network error: Could not connect to server');
        }
    } else {
        // Add new patient - Call API
        try {
            const response = await fetch('http://127.0.0.1:8000/api/v1/home/case', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    patientName: patientName,
                    patientAge: patientAge,
                    gender: gender,
                    phoneNumber: phoneNumber
                })
            });

            const result = await response.json();
            
            if (result.success) {
                // Add to local array on success
                const newPatient = {
                    ...patientData,
                    status: 'waiting',
                    paidAmount: 0,
                    remaining: patientData.totalPay || 0
                };
                patients.push(newPatient);
                
                populateTable();
                updateStats();
                closePatientModal();
                
                // Show success message (optional)
                alert('Patient added successfully!');
            } else {
                alert('Error: ' + (result.message || 'Failed to add patient'));
            }
        } catch (error) {
            console.error('Error adding patient:', error);
            alert('Network error: Could not connect to server');
        }
    }
}

// Payment modal functions




// Print patient details
function printPatient(patientId) {
    console.log('printPatient called with ID:', patientId);
    const patient = patients.find(p => p.id === patientId);
    console.log('Found patient for print:', patient);
    if (patient) {
        // Populate print card
        const dateObj = patient.date ? new Date(patient.date) : null;
        console.log('Date object:', dateObj);
        const safeDateText = (dateObj && !isNaN(dateObj)) ? dateObj.toLocaleDateString() : '';
        console.log('Safe date text:', safeDateText);

        const printFields = {
            'printId': patient.id ?? '',
            'printName': patient.name ?? '',
            'printAge': patient.age ?? '',
            'printPhone': patient.phone ?? '',
            'printGender': patient.gender ?? '',
            'printDate': safeDateText
        };

        Object.keys(printFields).forEach(fieldId => {
            const field = document.getElementById(fieldId);
            if (field) {
                field.textContent = printFields[fieldId];
                console.log(`Set ${fieldId} to:`, printFields[fieldId]);
            } else {
                console.warn(`Print field not found: ${fieldId}`);
            }
        });

        console.log('Triggering print...');
        // Print
        window.print();
    } else {
        console.error('Patient not found for print with ID:', patientId);
    }
}

// Update time and date
function updateDateTime() {
    const now = new Date();
    const timeElement = document.getElementById('time');
    const dateElement = document.getElementById('date');
    
    if (timeElement) {
        timeElement.textContent = now.toLocaleTimeString('en-US', {
            hour: 'numeric',
            minute: '2-digit',
            hour12: true
        });
    }
    
    if (dateElement) {
        dateElement.textContent = now.toLocaleDateString('en-US', {
            month: 'short',
            day: '2-digit',
            year: 'numeric'
        });
    }
}

// Close modal helper
function closeModal(event) {
    if (event.target === event.currentTarget) {
        const patientModal = document.getElementById('patientModal');
        const paymentModal = document.getElementById('paymentModal');
        
        if (patientModal && patientModal.classList.contains('active')) {
            closePatientModal();
        }
        if (paymentModal && paymentModal.classList.contains('active')) {
            closePaymentModal();
        }
    }
}

// Close modals with Escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closePatientModal();
    }
});

// Close mobile sidebar when clicking outside
document.addEventListener('click', function(e) {
    const sidebar = document.getElementById('sidebar');
    const mobileMenuBtn = document.querySelector('.mobile-menu-btn');
    
    if (sidebar && mobileMenuBtn && !sidebar.contains(e.target) && !mobileMenuBtn.contains(e.target)) {
        sidebar.classList.remove('open');
    }
});
    </script>
</body>
</html>